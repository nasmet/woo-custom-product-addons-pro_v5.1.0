"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[1774],{3462:function(e,t,r){r.d(t,{Z:function(){return jr}});var s=r(4060),i=r(9537);function o(e,t){if(!Object.prototype.hasOwnProperty.call(e,t))throw new TypeError("attempted to use private field on non-instance");return e}var n=0;function a(e){return"__private_"+n+++"_"+e}var l=a("emitter"),u=a("events");class p{constructor(e){Object.defineProperty(this,l,{writable:!0,value:void 0}),Object.defineProperty(this,u,{writable:!0,value:[]}),o(this,l)[l]=e}on(e,t){return o(this,u)[u].push([e,t]),o(this,l)[l].on(e,t)}remove(){for(const[e,t]of o(this,u)[u].splice(0))o(this,l)[l].off(e,t)}}var d=r(3493);var h=d((function(e,t,r){const{progress:s,bytesUploaded:i,bytesTotal:o}=t;s&&(e.uppy.log(`Upload progress: ${s}`),e.uppy.emit("upload-progress",r,{uploader:e,bytesUploaded:i,bytesTotal:o}))}),300,{leading:!0,trailing:!0});function c(e,t){if(!Object.prototype.hasOwnProperty.call(e,t))throw new TypeError("attempted to use private field on non-instance");return e}var m=0;function y(e){return"__private_"+m+++"_"+e}function f(e){if(null!=e){var t;const r=()=>this.abort(e.reason);e.addEventListener("abort",r,{once:!0});const s=()=>{e.removeEventListener("abort",r)};null==(t=this.then)||t.call(this,s,s)}return this}var b=y("activeRequests"),v=y("queuedHandlers"),w=y("paused"),g=y("pauseTimer"),P=y("downLimit"),O=y("upperLimit"),U=y("rateLimitingTimer"),j=y("call"),E=y("queueNext"),S=y("next"),k=y("queue"),T=y("dequeue"),C=y("resume"),R=y("increaseLimit");class F{constructor(e){Object.defineProperty(this,T,{value:L}),Object.defineProperty(this,k,{value:x}),Object.defineProperty(this,S,{value:A}),Object.defineProperty(this,E,{value:$}),Object.defineProperty(this,j,{value:M}),Object.defineProperty(this,b,{writable:!0,value:0}),Object.defineProperty(this,v,{writable:!0,value:[]}),Object.defineProperty(this,w,{writable:!0,value:!1}),Object.defineProperty(this,g,{writable:!0,value:void 0}),Object.defineProperty(this,P,{writable:!0,value:1}),Object.defineProperty(this,O,{writable:!0,value:void 0}),Object.defineProperty(this,U,{writable:!0,value:void 0}),Object.defineProperty(this,C,{writable:!0,value:()=>this.resume()}),Object.defineProperty(this,R,{writable:!0,value:()=>{if(c(this,w)[w])c(this,U)[U]=setTimeout(c(this,R)[R],0);else{c(this,P)[P]=this.limit,this.limit=Math.ceil((c(this,O)[O]+c(this,P)[P])/2);for(let e=c(this,P)[P];e<=this.limit;e++)c(this,E)[E]();c(this,O)[O]-c(this,P)[P]>3?c(this,U)[U]=setTimeout(c(this,R)[R],2e3):c(this,P)[P]=Math.floor(c(this,P)[P]/2)}}}),this.limit="number"!=typeof e||0===e?1/0:e}run(e,t){return!c(this,w)[w]&&c(this,b)[b]<this.limit?c(this,j)[j](e):c(this,k)[k](e,t)}wrapSyncFunction(e,t){var r=this;return function(){for(var s=arguments.length,i=new Array(s),o=0;o<s;o++)i[o]=arguments[o];const n=r.run((()=>(e(...i),queueMicrotask((()=>n.done())),()=>{})),t);return{abortOn:f,abort(){n.abort()}}}}wrapPromiseFunction(e,t){var r=this;return function(){for(var s=arguments.length,i=new Array(s),o=0;o<s;o++)i[o]=arguments[o];let n;const a=new Promise(((s,o)=>{n=r.run((()=>{let t,r;try{r=Promise.resolve(e(...i))}catch(e){r=Promise.reject(e)}return r.then((e=>{t?o(t):(n.done(),s(e))}),(e=>{t?o(t):(n.done(),o(e))})),e=>{t=function(e){return new Error("Cancelled",{cause:e})}(e)}}),t)}));return a.abort=e=>{n.abort(e)},a.abortOn=f,a}}resume(){c(this,w)[w]=!1,clearTimeout(c(this,g)[g]);for(let e=0;e<this.limit;e++)c(this,E)[E]()}pause(e){void 0===e&&(e=null),c(this,w)[w]=!0,clearTimeout(c(this,g)[g]),null!=e&&(c(this,g)[g]=setTimeout(c(this,C)[C],e))}rateLimit(e){clearTimeout(c(this,U)[U]),this.pause(e),this.limit>1&&Number.isFinite(this.limit)&&(c(this,O)[O]=this.limit-1,this.limit=c(this,P)[P],c(this,U)[U]=setTimeout(c(this,R)[R],e))}get isPaused(){return c(this,w)[w]}}function M(e){c(this,b)[b]+=1;let t,r=!1;try{t=e()}catch(e){throw c(this,b)[b]-=1,e}return{abort:e=>{r||(r=!0,c(this,b)[b]-=1,t(e),c(this,E)[E]())},done:()=>{r||(r=!0,c(this,b)[b]-=1,c(this,E)[E]())}}}function $(){queueMicrotask((()=>c(this,S)[S]()))}function A(){if(c(this,w)[w]||c(this,b)[b]>=this.limit)return;if(0===c(this,v)[v].length)return;const e=c(this,v)[v].shift(),t=c(this,j)[j](e.fn);e.abort=t.abort,e.done=t.done}function x(e,t){void 0===t&&(t={});const r={fn:e,priority:t.priority||0,abort:()=>{c(this,T)[T](r)},done:()=>{throw new Error("Cannot mark a queued request as done: this indicates a bug")}},s=c(this,v)[v].findIndex((e=>r.priority>e.priority));return-1===s?c(this,v)[v].push(r):c(this,v)[v].splice(s,0,r),r}function L(e){const t=c(this,v)[v].indexOf(e);-1!==t&&c(this,v)[v].splice(t,1)}Symbol("__queue");const{AbortController:q}=globalThis,{AbortSignal:I}=globalThis,_=function(e,t){void 0===e&&(e="Aborted");const r=new DOMException(e,"AbortError");var s,i;return null!=t&&(s=t,i="cause",Object.prototype.hasOwnProperty.call(s,i))&&Object.defineProperty(r,"cause",{__proto__:null,configurable:!0,writable:!0,value:t.cause}),r};function H(e,t){if(!Object.prototype.hasOwnProperty.call(e,t))throw new TypeError("attempted to use private field on non-instance");return e}var N=0;function z(e){return"__private_"+N+++"_"+e}const D={getChunkSize(e){return Math.ceil(e.size/1e4)},onProgress(){},onPartComplete(){},onSuccess(){},onError(e){throw e}};const X=Symbol("pausing upload, not an actual error");var B=z("abortController"),K=z("chunks"),W=z("chunkState"),Q=z("data"),Z=z("file"),V=z("uploadHasStarted"),G=z("onError"),J=z("onSuccess"),Y=z("shouldUseMultipart"),ee=z("isRestoring"),te=z("onReject"),re=z("maxMultipartParts"),se=z("minPartSize"),ie=z("initChunks"),oe=z("createUpload"),ne=z("resumeUpload"),ae=z("onPartProgress"),le=z("onPartComplete"),ue=z("abortUpload");function pe(){const e=H(this,Q)[Q].size,t="function"==typeof H(this,Y)[Y]?H(this,Y)[Y](H(this,Z)[Z]):Boolean(H(this,Y)[Y]);if(t&&e>H(this,se)[se]){let r=Math.max(this.options.getChunkSize(H(this,Q)[Q]),H(this,se)[se]),s=Math.floor(e/r);s>H(this,re)[re]&&(s=H(this,re)[re],r=e/H(this,re)[re]),H(this,K)[K]=Array(s);for(let s=0,i=0;s<e;s+=r,i++){const o=Math.min(e,s+r),n=()=>{const e=s;return H(this,Q)[Q].slice(e,o)};if(H(this,K)[K][i]={getData:n,onProgress:H(this,ae)[ae](i),onComplete:H(this,le)[le](i),shouldUseMultipart:t},H(this,ee)[ee]){const t=s+r>e?e-s:r;H(this,K)[K][i].setAsUploaded=()=>{H(this,W)[W][i].uploaded=t}}}}else H(this,K)[K]=[{getData:()=>H(this,Q)[Q],onProgress:H(this,ae)[ae](0),onComplete:H(this,le)[le](0),shouldUseMultipart:t}];H(this,W)[W]=H(this,K)[K].map((()=>({uploaded:0})))}function de(){this.options.companionComm.uploadFile(H(this,Z)[Z],H(this,K)[K],H(this,B)[B].signal).then(H(this,J)[J],H(this,te)[te]),H(this,V)[V]=!0}function he(){this.options.companionComm.resumeUploadFile(H(this,Z)[Z],H(this,K)[K],H(this,B)[B].signal).then(H(this,J)[J],H(this,te)[te])}function ce(){H(this,B)[B].abort(),this.options.companionComm.abortFileUpload(H(this,Z)[Z]).catch((e=>this.options.log(e)))}var me=class{constructor(e,t){var r;Object.defineProperty(this,ue,{value:ce}),Object.defineProperty(this,ne,{value:he}),Object.defineProperty(this,oe,{value:de}),Object.defineProperty(this,ie,{value:pe}),Object.defineProperty(this,B,{writable:!0,value:new q}),Object.defineProperty(this,K,{writable:!0,value:void 0}),Object.defineProperty(this,W,{writable:!0,value:void 0}),Object.defineProperty(this,Q,{writable:!0,value:void 0}),Object.defineProperty(this,Z,{writable:!0,value:void 0}),Object.defineProperty(this,V,{writable:!0,value:!1}),Object.defineProperty(this,G,{writable:!0,value:void 0}),Object.defineProperty(this,J,{writable:!0,value:void 0}),Object.defineProperty(this,Y,{writable:!0,value:void 0}),Object.defineProperty(this,ee,{writable:!0,value:void 0}),Object.defineProperty(this,te,{writable:!0,value:e=>(null==e?void 0:e.cause)===X?null:H(this,G)[G](e)}),Object.defineProperty(this,re,{writable:!0,value:1e4}),Object.defineProperty(this,se,{writable:!0,value:5242880}),Object.defineProperty(this,ae,{writable:!0,value:e=>t=>{if(!t.lengthComputable)return;H(this,W)[W][e].uploaded=function(e){if("string"==typeof e)return parseInt(e,10);if("number"==typeof e)return e;throw new TypeError("Expected a number")}(t.loaded);const r=H(this,W)[W].reduce(((e,t)=>e+t.uploaded),0);this.options.onProgress(r,H(this,Q)[Q].size)}}),Object.defineProperty(this,le,{writable:!0,value:e=>t=>{H(this,K)[K][e]=null,H(this,W)[W][e].etag=t,H(this,W)[W][e].done=!0;const r={PartNumber:e+1,ETag:t};this.options.onPartComplete(r)}}),this.options={...D,...t},null!=(r=this.options).getChunkSize||(r.getChunkSize=D.getChunkSize),H(this,Q)[Q]=e,H(this,Z)[Z]=t.file,H(this,J)[J]=this.options.onSuccess,H(this,G)[G]=this.options.onError,H(this,Y)[Y]=this.options.shouldUseMultipart,H(this,ee)[ee]=t.uploadId&&t.key,H(this,ie)[ie]()}start(){H(this,V)[V]?(H(this,B)[B].signal.aborted||H(this,B)[B].abort(X),H(this,B)[B]=new q,H(this,ne)[ne]()):H(this,ee)[ee]?(this.options.companionComm.restoreUploadFile(H(this,Z)[Z],{uploadId:this.options.uploadId,key:this.options.key}),H(this,ne)[ne]()):H(this,oe)[oe]()}pause(){H(this,B)[B].abort(X),H(this,B)[B]=new q}abort(e){var t;void 0===e&&(e=void 0),null!=(t=e)&&t.really?H(this,ue)[ue]():this.pause()}get chunkState(){return H(this,W)[W]}};const{subtle:ye}=globalThis.crypto,fe=new TextEncoder,be={name:"HMAC",hash:"SHA-256"};function ve(e){const t=new Uint8Array(e);let r="";for(let e=0;e<t.length;e++)r+=t[e].toString(16).padStart(2,"0");return r}async function we(e,t){return ye.sign(be,await async function(e){return ye.importKey("raw","string"==typeof e?fe.encode(e):e,be,!1,["sign"])}(e),fe.encode(t))}async function ge(e){let{accountKey:t,accountSecret:r,sessionToken:s,bucketName:i,Key:o,Region:n,expires:a,uploadId:l,partNumber:u}=e;const p="s3",d=`${i}.${p}.${n}.amazonaws.com`,h=`/${encodeURI(o)}`,c="UNSIGNED-PAYLOAD",m=(new Date).toISOString().replace(/[-:]|\.\d+/g,""),y=m.slice(0,8),f=`${y}/${n}/${p}/aws4_request`,b=new URL(`https://${d}${h}`);b.searchParams.set("X-Amz-Algorithm","AWS4-HMAC-SHA256"),b.searchParams.set("X-Amz-Content-Sha256",c),b.searchParams.set("X-Amz-Credential",`${t}/${f}`),b.searchParams.set("X-Amz-Date",m),b.searchParams.set("X-Amz-Expires",a),b.searchParams.set("X-Amz-Security-Token",s),b.searchParams.set("X-Amz-SignedHeaders","host"),u&&b.searchParams.set("partNumber",u),l&&b.searchParams.set("uploadId",l),b.searchParams.set("x-id",u&&l?"UploadPart":"PutObject");const v=function(e){let{method:t="PUT",CanonicalUri:r="/",CanonicalQueryString:s="",SignedHeaders:i,HashedPayload:o}=e;const n=Object.keys(i).map((e=>e.toLowerCase())).sort();return[t,r,s,...n.map((e=>`${e}:${i[e]}`)),"",n.join(";"),o].join("\n")}({CanonicalUri:h,CanonicalQueryString:b.search.slice(1),SignedHeaders:{host:d},HashedPayload:c}),w=["AWS4-HMAC-SHA256",m,f,ve(await async function(e){return ye.digest(be.hash,fe.encode(e))}(v))].join("\n"),g=await we(`AWS4${r}`,y),P=await we(g,n),O=await we(P,p),U=await we(O,"aws4_request"),j=ve(await we(U,w));return b.searchParams.set("X-Amz-Signature",j),b}let Pe;function Oe(e,t){if(!Object.prototype.hasOwnProperty.call(e,t))throw new TypeError("attempted to use private field on non-instance");return e}var Ue=0;function je(e){return"__private_"+Ue+++"_"+e}function Ee(e){if(e&&e.error){const t=new Error(e.message);throw Object.assign(t,e.error),t}return e}function Se(e){const t=e.Expiration;if(t){const e=Math.floor((new Date(t)-Date.now())/1e3);if(e>9)return e}}function ke(e){let{meta:t,allowedMetaFields:r,querify:s=!1}=e;const i=null!=r?r:Object.keys(t);return t?Object.fromEntries(i.filter((e=>null!=t[e])).map((e=>[s?`metadata[${e}]`:e,String(t[e])]))):{}}function Te(e){if(null!=e&&e.aborted)throw _("The operation was aborted",{cause:e.reason})}var Ce=je("abortMultipartUpload"),Re=je("cache"),Fe=je("createMultipartUpload"),Me=je("fetchSignature"),$e=je("getUploadParameters"),Ae=je("listParts"),xe=je("previousRetryDelay"),Le=je("requests"),qe=je("retryDelayIterator"),Ie=je("sendCompletionRequest"),_e=je("setS3MultipartState"),He=je("uploadPartBytes"),Ne=je("shouldRetry"),ze=je("nonMultipartUpload");class De{constructor(e,t,r){Object.defineProperty(this,ze,{value:Be}),Object.defineProperty(this,Ne,{value:Xe}),Object.defineProperty(this,Ce,{writable:!0,value:void 0}),Object.defineProperty(this,Re,{writable:!0,value:new WeakMap}),Object.defineProperty(this,Fe,{writable:!0,value:void 0}),Object.defineProperty(this,Me,{writable:!0,value:void 0}),Object.defineProperty(this,$e,{writable:!0,value:void 0}),Object.defineProperty(this,Ae,{writable:!0,value:void 0}),Object.defineProperty(this,xe,{writable:!0,value:void 0}),Object.defineProperty(this,Le,{writable:!0,value:void 0}),Object.defineProperty(this,qe,{writable:!0,value:void 0}),Object.defineProperty(this,Ie,{writable:!0,value:void 0}),Object.defineProperty(this,_e,{writable:!0,value:void 0}),Object.defineProperty(this,He,{writable:!0,value:void 0}),Oe(this,Le)[Le]=e,Oe(this,_e)[_e]=r,this.setOptions(t)}setOptions(e){const t=Oe(this,Le)[Le];var r;("abortMultipartUpload"in e&&(Oe(this,Ce)[Ce]=t.wrapPromiseFunction(e.abortMultipartUpload,{priority:1})),"createMultipartUpload"in e&&(Oe(this,Fe)[Fe]=t.wrapPromiseFunction(e.createMultipartUpload,{priority:-1})),"signPart"in e&&(Oe(this,Me)[Me]=t.wrapPromiseFunction(e.signPart)),"listParts"in e&&(Oe(this,Ae)[Ae]=t.wrapPromiseFunction(e.listParts)),"completeMultipartUpload"in e&&(Oe(this,Ie)[Ie]=t.wrapPromiseFunction(e.completeMultipartUpload,{priority:1})),"retryDelays"in e)&&(Oe(this,qe)[qe]=null==(r=e.retryDelays)?void 0:r.values());"uploadPartBytes"in e&&(Oe(this,He)[He]=t.wrapPromiseFunction(e.uploadPartBytes,{priority:1/0})),"getUploadParameters"in e&&(Oe(this,$e)[$e]=t.wrapPromiseFunction(e.getUploadParameters))}async getUploadId(e,t){let r;for(;null!=(r=Oe(this,Re)[Re].get(e.data));)try{return await r}catch{}const s=Oe(this,Fe)[Fe](e,t),i=()=>{s.abort(t.reason),Oe(this,Re)[Re].delete(e.data)};return t.addEventListener("abort",i,{once:!0}),Oe(this,Re)[Re].set(e.data,s),s.then((async r=>{t.removeEventListener("abort",i),Oe(this,_e)[_e](e,r),Oe(this,Re)[Re].set(e.data,r)}),(()=>{t.removeEventListener("abort",i),Oe(this,Re)[Re].delete(e.data)})),s}async abortFileUpload(e){const t=Oe(this,Re)[Re].get(e.data);if(null==t)return;let r;Oe(this,Re)[Re].delete(e.data),Oe(this,_e)[_e](e,Object.create(null));try{r=await t}catch{return}await Oe(this,Ce)[Ce](e,r)}async uploadFile(e,t,r){if(Te(r),1===t.length&&!t[0].shouldUseMultipart)return Oe(this,ze)[ze](e,t[0],r);const{uploadId:s,key:i}=await this.getUploadId(e,r);Te(r);try{const o=await Promise.all(t.map(((t,s)=>this.uploadChunk(e,s+1,t,r))));return Te(r),await Oe(this,Ie)[Ie](e,{key:i,uploadId:s,parts:o,signal:r}).abortOn(r)}catch(t){throw(null==t?void 0:t.cause)!==X&&"AbortError"!==(null==t?void 0:t.name)&&this.abortFileUpload(e),t}}restoreUploadFile(e,t){Oe(this,Re)[Re].set(e.data,t)}async resumeUploadFile(e,t,r){if(Te(r),1===t.length&&!t[0].shouldUseMultipart)return Oe(this,ze)[ze](e,t[0],r);const{uploadId:s,key:i}=await this.getUploadId(e,r);Te(r);const o=await Oe(this,Ae)[Ae](e,{uploadId:s,key:i,signal:r}).abortOn(r);Te(r);const n=await Promise.all(t.map(((t,s)=>{const i=s+1,n=o.find((e=>{let{PartNumber:t}=e;return t===i}));return null==n?this.uploadChunk(e,i,t,r):(null==t.setAsUploaded||t.setAsUploaded(),{PartNumber:i,ETag:n.ETag})})));return Te(r),Oe(this,Ie)[Ie](e,{key:i,uploadId:s,parts:n,signal:r}).abortOn(r)}async uploadChunk(e,t,r,s){Te(s);const{uploadId:i,key:o}=await this.getUploadId(e,s);for(Te(s);;){const n=r.getData(),{onProgress:a,onComplete:l}=r,u=await Oe(this,Me)[Me](e,{uploadId:i,key:o,partNumber:t,body:n,signal:s}).abortOn(s);Te(s);try{return{PartNumber:t,...await Oe(this,He)[He]({signature:u,body:n,size:n.size,onProgress:a,onComplete:l,signal:s}).abortOn(s)}}catch(e){if(!await Oe(this,Ne)[Ne](e))throw e}}}}async function Xe(e){var t;const r=Oe(this,Le)[Le],s=null==e||null==(t=e.source)?void 0:t.status;if(null==s)return!1;if(403===s&&"Request has expired"===e.message){if(!r.isPaused){if(1===r.limit||null==Oe(this,xe)[xe]){var i;const e=null==(i=Oe(this,qe)[qe])?void 0:i.next();if(null==e||e.done)return!1;Oe(this,xe)[xe]=e.value}r.rateLimit(0),await new Promise((e=>setTimeout(e,Oe(this,xe)[xe])))}}else if(429===s){if(!r.isPaused){var o;const e=null==(o=Oe(this,qe)[qe])?void 0:o.next();if(null==e||e.done)return!1;r.rateLimit(e.value)}}else{if(s>400&&s<500&&409!==s)return!1;if("undefined"!=typeof navigator&&!1===navigator.onLine)r.isPaused||(r.pause(),window.addEventListener("online",(()=>{r.resume()}),{once:!0}));else{var n;const e=null==(n=Oe(this,qe)[qe])?void 0:n.next();if(null==e||e.done)return!1;await new Promise((t=>setTimeout(t,e.value)))}}return!0}async function Be(e,t,r){const{method:s="post",url:i,fields:o,headers:n}=await Oe(this,$e)[$e](e,{signal:r}).abortOn(r);let a;const l=t.getData();if("post"===s){const e=new FormData;Object.entries(o).forEach((t=>{let[r,s]=t;return e.set(r,s)})),e.set("file",l),a=e}else a=l;const{onProgress:u,onComplete:p}=t;return Oe(this,He)[He]({signature:{url:i,headers:n,method:s},body:a,size:l.size,onProgress:u,onComplete:p,signal:r}).abortOn(r)}var Ke=je("companionCommunicationQueue"),We=je("client"),Qe=je("cachedTemporaryCredentials"),Ze=je("getTemporarySecurityCredentials"),Ve=je("setS3MultipartState"),Ge=je("uploadFile"),Je=je("requestSocketToken"),Ye=je("upload"),et=je("setCompanionHeaders"),tt=je("setResumableUploadsCapability"),rt=je("resetResumableCapability");Pe=Symbol.for("uppy test: getClient");class st extends s.Z{constructor(e,t){var r;super(e,t),Object.defineProperty(this,Ge,{value:ot}),Object.defineProperty(this,Ze,{value:it}),Object.defineProperty(this,Ke,{writable:!0,value:void 0}),Object.defineProperty(this,We,{writable:!0,value:void 0}),Object.defineProperty(this,Qe,{writable:!0,value:void 0}),Object.defineProperty(this,Ve,{writable:!0,value:(e,t)=>{let{key:r,uploadId:s}=t;const i=this.uppy.getFile(e.id);this.uppy.setFileState(e.id,{s3Multipart:{...i.s3Multipart,key:r,uploadId:s}})}}),Object.defineProperty(this,Je,{writable:!0,value:async(e,t)=>{const r=new(e.remote.providerOptions.provider?i.zt:i.C$)(this.uppy,e.remote.providerOptions),s={...this.opts};if(e.tus&&Object.assign(s,e.tus),null==e.remote.url)throw new Error("Cannot connect to an undefined URL");return(await r.post(e.remote.url,{...e.remote.body,protocol:"s3-multipart",size:e.data.size,metadata:e.meta},t)).token}}),Object.defineProperty(this,Ye,{writable:!0,value:async e=>{if(0===e.length)return;const t=function(e){return e.filter((e=>!(e=>"error"in e&&e.error)(e)))}(this.uppy.getFilesByIds(e)),r=function(e){return e.filter((e=>!e.progress.uploadStarted||!e.isRestored))}(t);this.uppy.emit("upload-start",r);const s=t.map((e=>{if(e.isRemote){Oe(this,tt)[tt](!1);const t=new AbortController,r=r=>{r.id===e.id&&t.abort()};this.uppy.on("file-removed",r),this.resetUploaderReferences(e.id);const s=this.uploadRemoteFile(e,{signal:t.signal});return this.requests.wrapSyncFunction((()=>{this.uppy.off("file-removed",r)}),{priority:-1})(),s}return Oe(this,Ge)[Ge](e)})),i=await Promise.all(s);return Oe(this,tt)[tt](!0),i}}),Object.defineProperty(this,et,{writable:!0,value:()=>{Oe(this,We)[We].setCompanionHeaders(this.opts.companionHeaders)}}),Object.defineProperty(this,tt,{writable:!0,value:e=>{const{capabilities:t}=this.uppy.getState();this.uppy.setState({capabilities:{...t,resumableUploads:e}})}}),Object.defineProperty(this,rt,{writable:!0,value:()=>{Oe(this,tt)[tt](!0)}}),this.type="uploader",this.id=this.opts.id||"AwsS3Multipart",this.title="AWS S3 Multipart",Oe(this,We)[We]=new i.C$(e,t);const s={allowedMetaFields:null,limit:6,shouldUseMultipart:e=>0!==e.size,retryDelays:[0,1e3,3e3,5e3],createMultipartUpload:this.createMultipartUpload.bind(this),listParts:this.listParts.bind(this),abortMultipartUpload:this.abortMultipartUpload.bind(this),completeMultipartUpload:this.completeMultipartUpload.bind(this),getTemporarySecurityCredentials:!1,signPart:null!=t&&t.getTemporarySecurityCredentials?this.createSignedURL.bind(this):this.signPart.bind(this),uploadPartBytes:st.uploadPartBytes,getUploadParameters:null!=t&&t.getTemporarySecurityCredentials?this.createSignedURL.bind(this):this.getUploadParameters.bind(this),companionHeaders:{}};this.opts={...s,...t},null!=(null==t?void 0:t.prepareUploadParts)&&null==t.signPart&&(this.opts.signPart=async(e,r)=>{let{uploadId:s,key:i,partNumber:o,body:n,signal:a}=r;const{presignedUrls:l,headers:u}=await t.prepareUploadParts(e,{uploadId:s,key:i,parts:[{number:o,chunk:n}],signal:a});return{url:null==l?void 0:l[o],headers:null==u?void 0:u[o]}}),this.requests=null!=(r=this.opts.rateLimitedQueue)?r:new F(this.opts.limit),Oe(this,Ke)[Ke]=new De(this.requests,this.opts,Oe(this,Ve)[Ve]),this.uploaders=Object.create(null),this.uploaderEvents=Object.create(null),this.uploaderSockets=Object.create(null),this.setQueueRequestSocketToken(this.requests.wrapPromiseFunction(Oe(this,Je)[Je],{priority:-1}))}[Pe](){return Oe(this,We)[We]}setOptions(e){return Oe(this,Ke)[Ke].setOptions(e),super.setOptions(e)}resetUploaderReferences(e,t){void 0===t&&(t={}),this.uploaders[e]&&(this.uploaders[e].abort({really:t.abort||!1}),this.uploaders[e]=null),this.uploaderEvents[e]&&(this.uploaderEvents[e].remove(),this.uploaderEvents[e]=null),this.uploaderSockets[e]&&(this.uploaderSockets[e].close(),this.uploaderSockets[e]=null)}assertHost(e){if(!this.opts.companionUrl)throw new Error(`Expected a \`companionUrl\` option containing a Companion address, or if you are not using Companion, a custom \`${e}\` implementation.`)}createMultipartUpload(e,t){this.assertHost("createMultipartUpload"),Te(t);const r=ke({meta:e.meta,allowedMetaFields:this.opts.allowedMetaFields});return Oe(this,We)[We].post("s3/multipart",{filename:e.name,type:e.type,metadata:r},{signal:t}).then(Ee)}listParts(e,t,r){let{key:s,uploadId:i}=t;this.assertHost("listParts"),Te(r);const o=encodeURIComponent(s);return Oe(this,We)[We].get(`s3/multipart/${i}?key=${o}`,{signal:r}).then(Ee)}completeMultipartUpload(e,t,r){let{key:s,uploadId:i,parts:o}=t;this.assertHost("completeMultipartUpload"),Te(r);const n=encodeURIComponent(s),a=encodeURIComponent(i);return Oe(this,We)[We].post(`s3/multipart/${a}/complete?key=${n}`,{parts:o},{signal:r}).then(Ee)}async createSignedURL(e,t){const r=await Oe(this,Ze)[Ze](t),s=Se(r.credentials)||604800,{uploadId:i,key:o,partNumber:n,signal:a}=t;return{method:"PUT",expires:s,fields:{},url:`${await ge({accountKey:r.credentials.AccessKeyId,accountSecret:r.credentials.SecretAccessKey,sessionToken:r.credentials.SessionToken,expires:s,bucketName:r.bucket,Region:r.region,Key:null!=o?o:`${crypto.randomUUID()}-${e.name}`,uploadId:i,partNumber:n,signal:a})}`,headers:{"Content-Type":e.type}}}signPart(e,t){let{uploadId:r,key:s,partNumber:i,signal:o}=t;if(this.assertHost("signPart"),Te(o),null==r||null==s||null==i)throw new Error("Cannot sign without a key, an uploadId, and a partNumber");const n=encodeURIComponent(s);return Oe(this,We)[We].get(`s3/multipart/${r}/${i}?key=${n}`,{signal:o}).then(Ee)}abortMultipartUpload(e,t,r){let{key:s,uploadId:i}=t;this.assertHost("abortMultipartUpload");const o=encodeURIComponent(s),n=encodeURIComponent(i);return Oe(this,We)[We].delete(`s3/multipart/${n}?key=${o}`,void 0,{signal:r}).then(Ee)}getUploadParameters(e,t){const{meta:r}=e,{type:s,name:i}=r,o=ke({meta:r,allowedMetaFields:this.opts.allowedMetaFields,querify:!0}),n=new URLSearchParams({filename:i,type:s,...o});return Oe(this,We)[We].get(`s3/params?${n}`,t)}static async uploadPartBytes(e){let{signature:{url:t,expires:r,headers:s,method:i="PUT"},body:o,size:n=o.size,onProgress:a,onComplete:l,signal:u}=e;if(Te(u),null==t)throw new Error("Cannot upload to an undefined URL");return new Promise(((e,p)=>{const d=new XMLHttpRequest;function h(){d.abort()}function c(){u.removeEventListener("abort",h)}d.open(i,t,!0),s&&Object.keys(s).forEach((e=>{d.setRequestHeader(e,s[e])})),d.responseType="text","number"==typeof r&&(d.timeout=1e3*r),u.addEventListener("abort",h),d.upload.addEventListener("progress",(e=>{a(e)})),d.addEventListener("abort",(()=>{c(),p(_())})),d.addEventListener("timeout",(()=>{c();const e=new Error("Request has expired");e.source={status:403},p(e)})),d.addEventListener("load",(t=>{if(c(),403===t.target.status&&t.target.responseText.includes("<Message>Request has expired</Message>")){const e=new Error("Request has expired");return e.source=t.target,void p(e)}if(t.target.status<200||t.target.status>=300){const e=new Error("Non 2xx");return e.source=t.target,void p(e)}null==a||a({loaded:n,lengthComputable:!0});const r=t.target.getResponseHeader("ETag");null!==r?(null==l||l(r),e({ETag:r})):p(new Error("AwsS3/Multipart: Could not read the ETag header. This likely means CORS is not configured correctly on the S3 Bucket. See https://uppy.io/docs/aws-s3-multipart#S3-Bucket-Configuration for instructions."))})),d.addEventListener("error",(e=>{c();const t=new Error("Unknown error");t.source=e.target,p(t)})),d.send(o)}))}async connectToServerSocket(e){var t=this;return new Promise(((r,s)=>{let o;const n=e.serverToken,a=function(e){const t=/^(?:https?:\/\/|\/\/)?(?:[^@\n]+@)?(?:www\.)?([^\n]+)/i.exec(e)[1];return`${/^http:\/\//i.test(e)?"ws":"wss"}://${t}`}(e.remote.companionUrl),l=new i.sk({target:`${a}/api/${n}`,autoOpen:!1});this.uploaderSockets[e.id]=l,this.uploaderEvents[e.id]=new p(this.uppy),this.onFileRemove(e.id,(()=>{l.send("cancel",{}),o.abort(),this.resetUploaderReferences(e.id,{abort:!0}),r(`upload ${e.id} was removed`)})),this.onFilePause(e.id,(e=>{e?(l.send("pause",{}),o.abort()):(o.abort(),o=this.requests.run((()=>(l.open(),l.send("resume",{}),()=>{}))))})),this.onPauseAll(e.id,(()=>{l.send("pause",{}),o.abort()})),this.onCancelAll(e.id,(function(s){let{reason:i}=void 0===s?{}:s;"user"===i&&(l.send("cancel",{}),o.abort(),t.resetUploaderReferences(e.id)),r(`upload ${e.id} was canceled`)})),this.onResumeAll(e.id,(()=>{o.abort(),e.error&&l.send("pause",{}),o=this.requests.run((()=>(l.open(),l.send("resume",{}),()=>{})))})),this.onRetry(e.id,(()=>{l.isOpen&&(l.send("pause",{}),l.send("resume",{}))})),this.onRetryAll(e.id,(()=>{l.isOpen&&(l.send("pause",{}),l.send("resume",{}))})),l.on("progress",(t=>h(this,t,e))),l.on("error",(t=>{this.uppy.emit("upload-error",e,new Error(t.error)),this.resetUploaderReferences(e.id),l.close(),o.done(),s(new Error(t.error))})),l.on("success",(t=>{const s={uploadURL:t.url};this.uppy.emit("upload-success",e,s),this.resetUploaderReferences(e.id),l.close(),o.done(),r()})),o=this.requests.run((()=>(e.isPaused?l.send("pause",{}):l.open(),()=>{})))}))}onFileRemove(e,t){this.uploaderEvents[e].on("file-removed",(r=>{e===r.id&&t(r.id)}))}onFilePause(e,t){this.uploaderEvents[e].on("upload-pause",((r,s)=>{e===r&&t(s)}))}onRetry(e,t){this.uploaderEvents[e].on("upload-retry",(r=>{e===r&&t()}))}onRetryAll(e,t){this.uploaderEvents[e].on("retry-all",(()=>{this.uppy.getFile(e)&&t()}))}onPauseAll(e,t){this.uploaderEvents[e].on("pause-all",(()=>{this.uppy.getFile(e)&&t()}))}onCancelAll(e,t){var r=this;this.uploaderEvents[e].on("cancel-all",(function(){r.uppy.getFile(e)&&t(...arguments)}))}onResumeAll(e,t){this.uploaderEvents[e].on("resume-all",(()=>{this.uppy.getFile(e)&&t()}))}install(){Oe(this,tt)[tt](!0),this.uppy.addPreProcessor(Oe(this,et)[et]),this.uppy.addUploader(Oe(this,Ye)[Ye]),this.uppy.on("cancel-all",Oe(this,rt)[rt])}uninstall(){this.uppy.removePreProcessor(Oe(this,et)[et]),this.uppy.removeUploader(Oe(this,Ye)[Ye]),this.uppy.off("cancel-all",Oe(this,rt)[rt])}}async function it(e){return Te(null==e?void 0:e.signal),null==Oe(this,Qe)[Qe]&&(!0===this.opts.getTemporarySecurityCredentials?(this.assertHost("getTemporarySecurityCredentials"),Oe(this,Qe)[Qe]=Oe(this,We)[We].get("s3/sts",null,e).then(Ee)):Oe(this,Qe)[Qe]=this.opts.getTemporarySecurityCredentials(e),Oe(this,Qe)[Qe]=await Oe(this,Qe)[Qe],setTimeout((()=>{Oe(this,Qe)[Qe]=null}),500*(Se(Oe(this,Qe)[Qe].credentials)||0))),Oe(this,Qe)[Qe]}function ot(e){var t=this;return new Promise(((r,s)=>{const i=()=>this.uppy.getFile(e.id)||e,o=new me(e.data,{companionComm:Oe(this,Ke)[Ke],log:function(){return t.uppy.log(...arguments)},getChunkSize:this.opts.getChunkSize?this.opts.getChunkSize.bind(this):null,onProgress:(t,r)=>{this.uppy.emit("upload-progress",e,{uploader:this,bytesUploaded:t,bytesTotal:r})},onError:t=>{this.uppy.log(t),this.uppy.emit("upload-error",e,t),this.resetUploaderReferences(e.id),s(t)},onSuccess:t=>{const s={body:{...t},uploadURL:t.location};this.resetUploaderReferences(e.id),this.uppy.emit("upload-success",i(),s),t.location&&this.uppy.log(`Download ${e.name} from ${t.location}`),r()},onPartComplete:e=>{this.uppy.emit("s3-multipart:part-uploaded",i(),e)},file:e,shouldUseMultipart:this.opts.shouldUseMultipart,...e.s3Multipart});this.uploaders[e.id]=o,this.uploaderEvents[e.id]=new p(this.uppy),this.onFileRemove(e.id,(t=>{o.abort(),this.resetUploaderReferences(e.id,{abort:!0}),r(`upload ${t.id} was removed`)})),this.onCancelAll(e.id,(function(s){let{reason:i}=void 0===s?{}:s;"user"===i&&(o.abort(),t.resetUploaderReferences(e.id,{abort:!0})),r(`upload ${e.id} was canceled`)})),this.onFilePause(e.id,(e=>{e?o.pause():o.start()})),this.onPauseAll(e.id,(()=>{o.pause()})),this.onResumeAll(e.id,(()=>{o.start()})),o.start()}))}function nt(e,t){if(!Object.prototype.hasOwnProperty.call(e,t))throw new TypeError("attempted to use private field on non-instance");return e}st.VERSION="3.5.0";var at=0;function lt(e){return"__private_"+at+++"_"+e}function ut(e){if(null!=e){var t;const r=()=>this.abort(e.reason);e.addEventListener("abort",r,{once:!0});const s=()=>{e.removeEventListener("abort",r)};null==(t=this.then)||t.call(this,s,s)}return this}var pt=lt("activeRequests"),dt=lt("queuedHandlers"),ht=lt("paused"),ct=lt("pauseTimer"),mt=lt("downLimit"),yt=lt("upperLimit"),ft=lt("rateLimitingTimer"),bt=lt("call"),vt=lt("queueNext"),wt=lt("next"),gt=lt("queue"),Pt=lt("dequeue"),Ot=lt("resume"),Ut=lt("increaseLimit");class jt{constructor(e){Object.defineProperty(this,Pt,{value:Ct}),Object.defineProperty(this,gt,{value:Tt}),Object.defineProperty(this,wt,{value:kt}),Object.defineProperty(this,vt,{value:St}),Object.defineProperty(this,bt,{value:Et}),Object.defineProperty(this,pt,{writable:!0,value:0}),Object.defineProperty(this,dt,{writable:!0,value:[]}),Object.defineProperty(this,ht,{writable:!0,value:!1}),Object.defineProperty(this,ct,{writable:!0,value:void 0}),Object.defineProperty(this,mt,{writable:!0,value:1}),Object.defineProperty(this,yt,{writable:!0,value:void 0}),Object.defineProperty(this,ft,{writable:!0,value:void 0}),Object.defineProperty(this,Ot,{writable:!0,value:()=>this.resume()}),Object.defineProperty(this,Ut,{writable:!0,value:()=>{if(nt(this,ht)[ht])nt(this,ft)[ft]=setTimeout(nt(this,Ut)[Ut],0);else{nt(this,mt)[mt]=this.limit,this.limit=Math.ceil((nt(this,yt)[yt]+nt(this,mt)[mt])/2);for(let e=nt(this,mt)[mt];e<=this.limit;e++)nt(this,vt)[vt]();nt(this,yt)[yt]-nt(this,mt)[mt]>3?nt(this,ft)[ft]=setTimeout(nt(this,Ut)[Ut],2e3):nt(this,mt)[mt]=Math.floor(nt(this,mt)[mt]/2)}}}),this.limit="number"!=typeof e||0===e?1/0:e}run(e,t){return!nt(this,ht)[ht]&&nt(this,pt)[pt]<this.limit?nt(this,bt)[bt](e):nt(this,gt)[gt](e,t)}wrapSyncFunction(e,t){var r=this;return function(){for(var s=arguments.length,i=new Array(s),o=0;o<s;o++)i[o]=arguments[o];const n=r.run((()=>(e(...i),queueMicrotask((()=>n.done())),()=>{})),t);return{abortOn:ut,abort(){n.abort()}}}}wrapPromiseFunction(e,t){var r=this;return function(){for(var s=arguments.length,i=new Array(s),o=0;o<s;o++)i[o]=arguments[o];let n;const a=new Promise(((s,o)=>{n=r.run((()=>{let t,r;try{r=Promise.resolve(e(...i))}catch(e){r=Promise.reject(e)}return r.then((e=>{t?o(t):(n.done(),s(e))}),(e=>{t?o(t):(n.done(),o(e))})),e=>{t=function(e){return new Error("Cancelled",{cause:e})}(e)}}),t)}));return a.abort=e=>{n.abort(e)},a.abortOn=ut,a}}resume(){nt(this,ht)[ht]=!1,clearTimeout(nt(this,ct)[ct]);for(let e=0;e<this.limit;e++)nt(this,vt)[vt]()}pause(e){void 0===e&&(e=null),nt(this,ht)[ht]=!0,clearTimeout(nt(this,ct)[ct]),null!=e&&(nt(this,ct)[ct]=setTimeout(nt(this,Ot)[Ot],e))}rateLimit(e){clearTimeout(nt(this,ft)[ft]),this.pause(e),this.limit>1&&Number.isFinite(this.limit)&&(nt(this,yt)[yt]=this.limit-1,this.limit=nt(this,mt)[mt],nt(this,ft)[ft]=setTimeout(nt(this,Ut)[Ut],e))}get isPaused(){return nt(this,ht)[ht]}}function Et(e){nt(this,pt)[pt]+=1;let t,r=!1;try{t=e()}catch(e){throw nt(this,pt)[pt]-=1,e}return{abort:e=>{r||(r=!0,nt(this,pt)[pt]-=1,t(e),nt(this,vt)[vt]())},done:()=>{r||(r=!0,nt(this,pt)[pt]-=1,nt(this,vt)[vt]())}}}function St(){queueMicrotask((()=>nt(this,wt)[wt]()))}function kt(){if(nt(this,ht)[ht]||nt(this,pt)[pt]>=this.limit)return;if(0===nt(this,dt)[dt].length)return;const e=nt(this,dt)[dt].shift(),t=nt(this,bt)[bt](e.fn);e.abort=t.abort,e.done=t.done}function Tt(e,t){void 0===t&&(t={});const r={fn:e,priority:t.priority||0,abort:()=>{nt(this,Pt)[Pt](r)},done:()=>{throw new Error("Cannot mark a queued request as done: this indicates a bug")}},s=nt(this,dt)[dt].findIndex((e=>r.priority>e.priority));return-1===s?nt(this,dt)[dt].push(r):nt(this,dt)[dt].splice(s,0,r),r}function Ct(e){const t=nt(this,dt)[dt].indexOf(e);-1!==t&&nt(this,dt)[dt].splice(t,1)}const Rt=Symbol("__queue");var Ft=r(9022);var Mt=d((function(e,t,r){const{progress:s,bytesUploaded:i,bytesTotal:o}=t;s&&(e.uppy.log(`Upload progress: ${s}`),e.uppy.emit("upload-progress",r,{uploader:e,bytesUploaded:i,bytesTotal:o}))}),300,{leading:!0,trailing:!0});function $t(e,t){if(!Object.prototype.hasOwnProperty.call(e,t))throw new TypeError("attempted to use private field on non-instance");return e}var At=0;function xt(e){return"__private_"+At+++"_"+e}var Lt=xt("emitter"),qt=xt("events");class It{constructor(e){Object.defineProperty(this,Lt,{writable:!0,value:void 0}),Object.defineProperty(this,qt,{writable:!0,value:[]}),$t(this,Lt)[Lt]=e}on(e,t){return $t(this,qt)[qt].push([e,t]),$t(this,Lt)[Lt].on(e,t)}remove(){for(const[e,t]of $t(this,qt)[qt].splice(0))$t(this,Lt)[Lt].off(e,t)}}function _t(e,t){if(!Object.prototype.hasOwnProperty.call(e,t))throw new TypeError("attempted to use private field on non-instance");return e}var Ht=0;function Nt(e){return"__private_"+Ht+++"_"+e}var zt=Nt("aliveTimer"),Dt=Nt("isDone"),Xt=Nt("onTimedOut"),Bt=Nt("timeout");var Kt=class{constructor(e,t){Object.defineProperty(this,zt,{writable:!0,value:void 0}),Object.defineProperty(this,Dt,{writable:!0,value:!1}),Object.defineProperty(this,Xt,{writable:!0,value:void 0}),Object.defineProperty(this,Bt,{writable:!0,value:void 0}),_t(this,Bt)[Bt]=e,_t(this,Xt)[Xt]=t}progress(){_t(this,Dt)[Dt]||_t(this,Bt)[Bt]>0&&(clearTimeout(_t(this,zt)[zt]),_t(this,zt)[zt]=setTimeout(_t(this,Xt)[Xt],_t(this,Bt)[Bt]))}done(){_t(this,Dt)[Dt]||(clearTimeout(_t(this,zt)[zt]),_t(this,zt)[zt]=null,_t(this,Dt)[Dt]=!0)}};class Wt extends Error{constructor(e,t){var r,s;void 0===t&&(t={}),super(e),this.cause=t.cause,this.cause&&(r=this.cause,s="isNetworkError",Object.prototype.hasOwnProperty.call(r,s))&&(this.isNetworkError=this.cause.isNetworkError)}}var Qt=Wt;class Zt extends Error{constructor(e,t){void 0===t&&(t=null),super("This looks like a network error, the endpoint might be blocked by an internet provider or a firewall."),this.cause=e,this.isNetworkError=!0,this.request=t}}var Vt=Zt;var Gt=function(e){return!!e&&(0!==e.readyState&&4!==e.readyState||0===e.status)};function Jt(e,t){if(!Object.prototype.hasOwnProperty.call(e,t))throw new TypeError("attempted to use private field on non-instance");return e}var Yt=0;function er(e){return"__private_"+Yt+++"_"+e}function tr(e,t){if(Gt(e))return new Vt(t,e);const r=new Qt("Upload error",{cause:t});return r.request=e,r}function rr(e,t){const r=new FormData;!function(e,t,r){(Array.isArray(r.allowedMetaFields)?r.allowedMetaFields:Object.keys(t)).forEach((r=>{e.append(r,t[r])}))}(r,e.meta,t);const s=function(e){return e.data.slice(0,e.data.size,e.meta.type)}(e);return e.name?r.append(t.fieldName,s,e.meta.name):r.append(t.fieldName,s),r}var sr=er("addEventHandlerForFile"),ir=er("addEventHandlerIfFileStillExists");class or{constructor(e,t){Object.defineProperty(this,ir,{value:ar}),Object.defineProperty(this,sr,{value:nr}),this.uppy=e,this.opts={validateStatus(e){return e>=200&&e<300},...t},this.requests=t[Rt],this.uploaderEvents=Object.create(null),this.i18n=t.i18n}getOptions(e){var t;const{uppy:r}=this,s=r.getState().xhrUpload;return{...this.opts,...s||{},...e.xhrUpload||{},headers:{...this.opts.headers,...null==s?void 0:s.headers,...null==(t=e.xhrUpload)?void 0:t.headers}}}uploadLocalFile(e){const t=this.getOptions(e);return new Promise(((r,s)=>{const i=t.formData?rr(e,t):(e=>e.data)(e),o=new XMLHttpRequest;this.uploaderEvents[e.id]=new It(this.uppy);const n=new Kt(t.timeout,(()=>{o.abort(),l.done();const r=new Error(this.i18n("timedOut",{seconds:Math.ceil(t.timeout/1e3)}));this.uppy.emit("upload-error",e,r),s(r)})),a=(0,Ft.x)();o.upload.addEventListener("loadstart",(()=>{this.uppy.log(`[AwsS3/XHRUpload] ${a} started`)})),o.upload.addEventListener("progress",(t=>{this.uppy.log(`[AwsS3/XHRUpload] ${a} progress: ${t.loaded} / ${t.total}`),n.progress(),t.lengthComputable&&this.uppy.emit("upload-progress",e,{uploader:this,bytesUploaded:t.loaded,bytesTotal:t.total})})),o.addEventListener("load",(i=>{if(this.uppy.log(`[AwsS3/XHRUpload] ${a} finished`),n.done(),l.done(),this.uploaderEvents[e.id]&&(this.uploaderEvents[e.id].remove(),this.uploaderEvents[e.id]=null),t.validateStatus(i.target.status,o.responseText,o)){const s=t.getResponseData(o.responseText,o),n=s[t.responseUrlFieldName],a={status:i.target.status,body:s,uploadURL:n};return this.uppy.emit("upload-success",e,a),n&&this.uppy.log(`Download ${e.name} from ${n}`),r(e)}const u=t.getResponseData(o.responseText,o),p=tr(o,t.getResponseError(o.responseText,o)),d={status:i.target.status,body:u};return this.uppy.emit("upload-error",e,p,d),s(p)})),o.addEventListener("error",(()=>{this.uppy.log(`[AwsS3/XHRUpload] ${a} errored`),n.done(),l.done(),this.uploaderEvents[e.id]&&(this.uploaderEvents[e.id].remove(),this.uploaderEvents[e.id]=null);const r=tr(o,t.getResponseError(o.responseText,o));return this.uppy.emit("upload-error",e,r),s(r)})),o.open(t.method.toUpperCase(),t.endpoint,!0),o.withCredentials=Boolean(t.withCredentials),""!==t.responseType&&(o.responseType=t.responseType),Object.keys(t.headers).forEach((e=>{o.setRequestHeader(e,t.headers[e])}));const l=this.requests.run((()=>(o.send(i),()=>{n.done(),o.abort()})),{priority:1});Jt(this,sr)[sr]("file-removed",e.id,(()=>{l.abort(),s(new Error("File removed"))})),Jt(this,ir)[ir]("cancel-all",e.id,(function(e){let{reason:t}=void 0===e?{}:e;"user"===t&&l.abort(),s(new Error("Upload cancelled"))}))}))}async connectToServerSocket(e){return new Promise(((t,r)=>{const s=this.getOptions(e),o=e.serverToken,n=function(e){const t=/^(?:https?:\/\/|\/\/)?(?:[^@\n]+@)?(?:www\.)?([^\n]+)/i.exec(e)[1];return`${/^http:\/\//i.test(e)?"ws":"wss"}://${t}`}(e.remote.companionUrl);let a;const l=()=>{null==a&&(a=new i.sk({target:`${n}/api/${o}`}),a.on("progress",(t=>Mt(this,t,e))),a.on("success",(r=>{const i=s.getResponseData(r.response.responseText,r.response),o=i[s.responseUrlFieldName],n={status:r.response.status,body:i,uploadURL:o,bytesUploaded:r.bytesUploaded};return this.uppy.emit("upload-success",e,n),u.done(),a.close(),this.uploaderEvents[e.id]&&(this.uploaderEvents[e.id].remove(),this.uploaderEvents[e.id]=null),t()})),a.on("error",(t=>{const i=t.response,o=i?s.getResponseError(i.responseText,i):new Qt(t.error.message,{cause:t.error});this.uppy.emit("upload-error",e,o),u.done(),this.uploaderEvents[e.id]&&(this.uploaderEvents[e.id].remove(),this.uploaderEvents[e.id]=null),r(o)})))};this.uploaderEvents[e.id]=new It(this.uppy);let u=this.requests.run((()=>{var t;e.isPaused?null==(t=a)||t.send("pause",{}):l();return()=>a.close()}));Jt(this,sr)[sr]("file-removed",e.id,(()=>{var r;null==(r=a)||r.send("cancel",{}),u.abort(),t(`upload ${e.id} was removed`)})),Jt(this,ir)[ir]("cancel-all",e.id,(function(r){let{reason:s}=void 0===r?{}:r;var i;"user"===s&&(null==(i=a)||i.send("cancel",{}),u.abort());t(`upload ${e.id} was canceled`)}));const p=()=>{null==a?u.abort():(a.send("pause",{}),u.done()),u=this.requests.run((()=>(e.isPaused||(null==a?l():a.send("resume",{})),()=>a.close())))};Jt(this,sr)[sr]("upload-retry",e.id,p),Jt(this,ir)[ir]("retry-all",e.id,p)})).catch((t=>(this.uppy.emit("upload-error",e,t),Promise.reject(t))))}}function nr(e,t,r){this.uploaderEvents[t].on(e,(e=>{var s;const i=null!=(s=null==e?void 0:e.id)?s:e;t===i&&r()}))}function ar(e,t,r){var s=this;this.uploaderEvents[t].on(e,(function(){s.uppy.getFile(t)&&r(...arguments)}))}var lr=function(e,t){const r=t.headers?t.headers["content-type"]:t.getResponseHeader("Content-Type");if("string"==typeof r){const t=(s=r,s.replace(/;.*$/,"")).toLowerCase();if("application/xml"===t||"text/xml"===t)return!0;if("text/html"===t&&/^<\?xml /.test(e))return!0}var s;return!1},ur={strings:{timedOut:"Upload stalled for %{seconds} seconds, aborting."}};let pr;function dr(e,t){if(!Object.prototype.hasOwnProperty.call(e,t))throw new TypeError("attempted to use private field on non-instance");return e}var hr=0;function cr(e){return"__private_"+hr+++"_"+e}function mr(e,t){const r=e.indexOf(`<${t}>`),s=e.indexOf(`</${t}>`,r);return-1!==r&&-1!==s?e.slice(r+t.length+2,s):""}function yr(e){if(e&&e.error){const t=new Error(e.message);throw Object.assign(t,e.error),t}return e}function fr(e,t){if(!lr(e,t))return;const r=mr(e,"Message");return new Error(r)}let br=!1;var vr=cr("client"),wr=cr("requests"),gr=cr("uploader"),Pr=cr("handleUpload"),Or=cr("setCompanionHeaders"),Ur=cr("requestSocketToken");pr=Symbol.for("uppy test: getClient");class jr extends s.Z{constructor(e,t){if(null!=(null==t?void 0:t.shouldUseMultipart))return new st(e,t);super(e,t),Object.defineProperty(this,vr,{writable:!0,value:void 0}),Object.defineProperty(this,wr,{writable:!0,value:void 0}),Object.defineProperty(this,gr,{writable:!0,value:void 0}),Object.defineProperty(this,Pr,{writable:!0,value:async e=>{const t=Object.create(null);function r(e){var r;const{id:s}=e;null==(r=t[s])||r.abort()}this.uppy.on("file-removed",r);const s=function(e){return e.filter((e=>!(e=>"error"in e&&e.error)(e)))}(this.uppy.getFilesByIds(e)),i=function(e){return e.filter((e=>!e.progress.uploadStarted||!e.isRestored))}(s);this.uppy.emit("upload-start",i);const o=dr(this,wr)[wr].wrapPromiseFunction((e=>this.opts.getUploadParameters(e))),n=e.length;return Promise.allSettled(e.map(((e,r)=>(t[e]=o(this.uppy.getFile(e)),t[e].then((s=>{delete t[e];const i=this.uppy.getFile(e);!function(e,t){if(null==t||"string"!=typeof t.url||"object"!=typeof t.fields&&null!=t.fields)throw new TypeError(`AwsS3: got incorrect result from 'getUploadParameters()' for file '${e.name}', expected an object '{ url, method, fields, headers }' but got '${JSON.stringify(t)}' instead.\nSee https://uppy.io/docs/aws-s3/#getUploadParameters-file for more on the expected format.`);if(null!=t.method&&!/^p(u|os)t$/i.test(t.method))throw new TypeError(`AwsS3: got incorrect method from 'getUploadParameters()' for file '${e.name}', expected  'put' or 'post' but got '${t.method}' instead.\nSee https://uppy.io/docs/aws-s3/#getUploadParameters-file for more on the expected format.`)}(i,s);const{method:o="post",url:a,fields:l,headers:u}=s,p={method:o,formData:"post"===o.toLowerCase(),endpoint:a,allowedMetaFields:l?Object.keys(l):[]};return u&&(p.headers=u),this.uppy.setFileState(i.id,{meta:{...i.meta,...l},xhrUpload:p}),this.uploadFile(i.id,r,n)})).catch((r=>{delete t[e];const s=this.uppy.getFile(e);return this.uppy.emit("upload-error",s,r),Promise.reject(r)})))))).finally((()=>{this.uppy.off("file-removed",r)}))}}),Object.defineProperty(this,Or,{writable:!0,value:()=>(dr(this,vr)[vr].setCompanionHeaders(this.opts.companionHeaders),Promise.resolve())}),Object.defineProperty(this,Ur,{writable:!0,value:async e=>{const t=dr(this,gr)[gr].getOptions(e),r=new(e.remote.providerOptions.provider?i.zt:i.C$)(this.uppy,e.remote.providerOptions),s=Array.isArray(t.allowedMetaFields)?t.allowedMetaFields:Object.keys(e.meta);e.tus&&Object.assign(t,e.tus);return(await r.post(e.remote.url,{...e.remote.body,protocol:"multipart",endpoint:t.endpoint,size:e.data.size,fieldname:t.fieldName,metadata:Object.fromEntries(s.map((t=>[t,e.meta[t]]))),httpMethod:t.method,useFormData:t.formData,headers:t.headers})).token}}),this.type="uploader",this.id=this.opts.id||"AwsS3",this.title="AWS S3",this.defaultLocale=ur;const r={timeout:3e4,limit:0,allowedMetaFields:[],getUploadParameters:this.getUploadParameters.bind(this),shouldUseMultipart:!1,companionHeaders:{}};if(this.opts={...r,...t},void 0===(null==t?void 0:t.allowedMetaFields)&&"metaFields"in this.opts)throw new Error("The `metaFields` option has been renamed to `allowedMetaFields`.");this.i18nInit(),dr(this,vr)[vr]=new i.C$(e,t),dr(this,wr)[wr]=new jt(this.opts.limit),this.setQueueRequestSocketToken(dr(this,wr)[wr].wrapPromiseFunction(dr(this,Ur)[Ur],{priority:-1}))}[pr](){return dr(this,vr)[vr]}get client(){return dr(this,vr)[vr]}set client(e){dr(this,vr)[vr]=e}getUploadParameters(e){if(!this.opts.companionUrl)throw new Error("Expected a `companionUrl` option containing a Companion address.");const t=e.meta.name,{type:r}=e.meta,s=Object.fromEntries(this.opts.allowedMetaFields.filter((t=>null!=e.meta[t])).map((t=>[`metadata[${t}]`,e.meta[t].toString()]))),i=new URLSearchParams({filename:t,type:r,...s});return dr(this,vr)[vr].get(`s3/params?${i}`).then(yr)}connectToServerSocket(e){return dr(this,gr)[gr].connectToServerSocket(e)}uploadFile(e,t,r){const s=this.uppy.getFile(e);if(this.uppy.log(`uploading ${t} of ${r}`),s.error)throw new Error(s.error);if(s.isRemote){const e=new AbortController,t=t=>{t.id===s.id&&e.abort()};this.uppy.on("file-removed",t);const r=this.uploadRemoteFile(s,{signal:e.signal});return dr(this,wr)[wr].wrapSyncFunction((()=>{this.uppy.off("file-removed",t)}),{priority:-1})(),r}return dr(this,gr)[gr].uploadLocalFile(s,t,r)}install(){const{uppy:e}=this;e.addPreProcessor(dr(this,Or)[Or]),e.addUploader(dr(this,Pr)[Pr]);const t={fieldName:"file",responseUrlFieldName:"location",timeout:this.opts.timeout,[Rt]:dr(this,wr)[wr],responseType:"text",getResponseData:this.opts.getResponseData||function(t,r){const s=this;return lr(t,r)?{location:(i=r.responseURL,o=mr(t,"Location"),i||o.startsWith("https://")||o.startsWith("http://")||(o=`https://${o}`),new URL(o,i||void 0).toString()),bucket:mr(t,"Bucket"),key:mr(t,"Key"),etag:mr(t,"ETag")}:"POST"===s.method.toUpperCase()?(br||(e.log("[AwsS3] No response data found, make sure to set the success_action_status AWS SDK option to 201. See https://uppy.io/docs/aws-s3/#POST-Uploads","warning"),br=!0),{location:null}):r.responseURL?{location:r.responseURL.replace(/\?.*$/,"")}:{location:null};var i,o},getResponseError:fr};t.i18n=this.i18n,dr(this,gr)[gr]=new or(e,t)}uninstall(){this.uppy.removePreProcessor(dr(this,Or)[Or]),this.uppy.removeUploader(dr(this,Pr)[Pr])}}jr.VERSION="3.2.1"}}]);